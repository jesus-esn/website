<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CO₂ Animation</title>
    <style>
      :root {
        --line: #d9e2ec;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: Aptos, "Libre Franklin", Arial, sans-serif;
        background: #ffffff;
        color: #000000;
      }

      .wrap {
        width: min(1000px, calc(100% - 2rem));
        margin: 1rem auto;
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 0.9rem;
      }

      canvas {
        width: 100%;
        height: auto;
        display: block;
        background: #ffffff;
        border: 1px solid var(--line);
        border-radius: 10px;
      }

      body.embed-mode .wrap {
        width: 100%;
        margin: 0;
        border: 0;
        border-radius: 0;
        padding: 0;
      }

      body.embed-mode canvas {
        border: 0;
        border-radius: 0;
      }
    </style>
  </head>
  <body>
    <main class="wrap">
      <canvas id="scene" width="900" height="600" aria-label="CO₂ carboxylation animation"></canvas>
    </main>

    <script>
      const params = new URLSearchParams(window.location.search);
      if (params.get("embed") === "1") {
        document.body.classList.add("embed-mode");
      }

      const canvas = document.getElementById("scene");
      const ctx = canvas.getContext("2d");
      const viewW = 900;
      const viewH = 600;
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(viewW * dpr);
      canvas.height = Math.floor(viewH * dpr);
      canvas.style.width = "100%";
      canvas.style.height = "auto";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineCap = "round";
      ctx.lineJoin = "round";

      const W = viewW;
      const H = viewH;
      const loopMs = 9000;
      const proteinColor = "#7aa8d8";
      const labelSize = 32;

      const squiggles = [
        { x0: 90, len: 330, y0: 165, phase: 0.1 },
        { x0: 95, len: 325, y0: 305, phase: 0.85 },
        { x0: 85, len: 335, y0: 445, phase: 1.45 }
      ];
      const lysineTs = [0.44, 0.56, 0.50];

      const co2Start = [
        { x: 118, y: 96 },
        { x: 250, y: 64 },
        { x: 380, y: 92 }
      ];

      const stepStart = [0.1, 0.36, 0.62];
      const stepDur = 0.18;

      function clamp01(v) {
        return Math.max(0, Math.min(1, v));
      }

      function ease(t) {
        const k = clamp01(t);
        return k * k * (3 - 2 * k);
      }

      function stepProgress(p, i) {
        return ease((p - stepStart[i]) / stepDur);
      }

      function attachedCount(p) {
        let count = 0;
        for (let i = 0; i < 3; i += 1) {
          if (stepProgress(p, i) >= 1) count += 1;
        }
        return count;
      }

      function squigglePoint(strand, t) {
        const s = squiggles[strand];
        const x = s.x0 + t * s.len;
        const y =
          s.y0 +
          Math.sin(t * Math.PI * 2.6 + s.phase) * 24 +
          Math.sin(t * Math.PI * 7.2 + s.phase * 1.35) * 8;
        return { x, y };
      }

      function drawProtein() {
        const points = 260;
        ctx.strokeStyle = proteinColor;
        ctx.lineWidth = 16;
        for (let strand = 0; strand < squiggles.length; strand += 1) {
          ctx.beginPath();
          for (let i = 0; i <= points; i += 1) {
            const t = i / points;
            const p = squigglePoint(strand, t);
            if (i === 0) ctx.moveTo(p.x, p.y);
            else ctx.lineTo(p.x, p.y);
          }
          ctx.stroke();
        }
      }

      function drawLysines() {
        const anchors = [];
        for (let i = 0; i < lysineTs.length; i += 1) {
          const base = squigglePoint(i, lysineTs[i]);
          const l = { x: base.x, y: base.y - 30 };
          anchors.push(l);
        }
        return anchors;
      }

      function drawCO2At(x, y, attached) {
        const sideOffset = 46;
        const sideR = 26;
        const centerR = 44;
        const sideDrop = 22;

        ctx.strokeStyle = attached ? "#7f1d1d" : "#be123c";
        ctx.lineWidth = 1.8;
        ctx.beginPath();
        ctx.moveTo(x - sideOffset + sideR, y + sideDrop);
        ctx.lineTo(x - centerR + 1, y + 2);
        ctx.moveTo(x + centerR - 1, y + 2);
        ctx.lineTo(x + sideOffset - sideR, y + sideDrop);
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(x - sideOffset, y + sideDrop, sideR, 0, Math.PI * 2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
        ctx.strokeStyle = "#94a3b8";
        ctx.lineWidth = 1.5;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(x + sideOffset, y + sideDrop, sideR, 0, Math.PI * 2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
        ctx.strokeStyle = "#94a3b8";
        ctx.lineWidth = 1.5;
        ctx.stroke();

        ctx.beginPath();
        ctx.arc(x, y, centerR, 0, Math.PI * 2);
        ctx.fillStyle = attached ? "#ef4444" : "#fda4af";
        ctx.fill();

        ctx.fillStyle = "#ffffff";
        ctx.font = `400 ${labelSize}px Aptos, "Libre Franklin", Arial, sans-serif`;
        const label = "CO₂";
        const tw = ctx.measureText(label).width;
        ctx.fillText(label, x - tw / 2, y + 10);
      }

      function drawPeakPanel(count) {
        const x0 = 500;
        const y0 = 70;
        const w = 360;
        const h = 470;

        const axisX = x0 + 45;
        const axisY = y0 + h - 45;
        ctx.strokeStyle = "#111827";
        ctx.lineWidth = 2.2;
        ctx.beginPath();
        ctx.moveTo(axisX, axisY);
        ctx.lineTo(axisX, y0 + 40);
        ctx.moveTo(axisX, axisY);
        ctx.lineTo(x0 + w - 26, axisY);
        ctx.stroke();

        const baseY = axisY;
        const peakX = x0 + 190;
        const maxH = 340;
        const target = count / 3;
        const peakH = maxH * (0.12 + 0.88 * target);

        ctx.strokeStyle = "#dc2626";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(x0 + 45, baseY);
        ctx.lineTo(peakX - 28, baseY);
        ctx.lineTo(peakX, baseY - peakH);
        ctx.lineTo(peakX + 28, baseY);
        ctx.lineTo(x0 + w - 26, baseY);
        ctx.stroke();
      }

      function frame(now) {
        const p = (now % loopMs) / loopMs;
        ctx.clearRect(0, 0, W, H);

        drawProtein();
        const lysines = drawLysines();

        for (let i = 0; i < 3; i += 1) {
          const prog = stepProgress(p, i);
          const sx = co2Start[i].x;
          const sy = co2Start[i].y;
          const tx = lysines[i].x;
          const ty = lysines[i].y - 26;
          const x = sx + (tx - sx) * prog;
          const y = sy + (ty - sy) * prog;

          if (p >= stepStart[i]) {
            drawCO2At(x, y, prog >= 1);
          }

          if (prog >= 1) {
            ctx.strokeStyle = "#7f1d1d";
            ctx.lineWidth = 2.2;
            ctx.beginPath();
            ctx.moveTo(lysines[i].x, lysines[i].y + 6);
            ctx.lineTo(x, y + 34);
            ctx.stroke();
          }
        }

        const count = attachedCount(p);
        drawPeakPanel(count);

        requestAnimationFrame(frame);
      }

      requestAnimationFrame(frame);
    </script>
  </body>
</html>
